import requests
import json
import sys

load_dotenv();
params = 'severity=low' + '&after=2022-09-01' + '&before=2022-09-06' #+ '&severity=low' # + '&product=openstack' + '&sevrity=important' + '&ids=CVE-2022-2735' 


def get_data(query):
    full_query = os.getenv('API_HOST') + query
    print(full_query)
    r = requests.get(full_query)

    if r.status_code != 200:
        print('ERROR: Invalid request; returned' + str(r.status_code) + 'for the following query: \n' + full_query)

    if not r.json():
        print('\nNo data returned with the following query: \n' + full_query)
        #print(full_query)
        print('\n')
        sys.exit(0)

    return r.json()

def pretty_print_cve(data):

    cves_printed = []

    print('\n')
    print('CVE Number: \t| Severity: | Public date: | URL: \n')

    for cve in data:
        #print('{} \t |   {} \t |   Public date:{}'.format(cve['CVE'], cve['severity'], cve['public_date']))
        if cve['CVE'] not in cves_printed:
            cves_printed.append(cve['CVE'])
            print('{:<15} | {:<9} | {:<12} | {:<50}'.format(cve['CVE'], cve['severity'], cve['public_date'][0:10], cve['resource_url']))
    
    #print(cves_printed)

    print('\n')


data = get_data(os.getenv('ENDPOINT') + '?' + params)
#data_json = json.dumps(data, indent=4)
#print(data_json)

pretty_print_cve(data)


""" for cve in data:
    params2 = 'ids=' + cve['CVE']
    data2 = get_data(os.getenv('ENDPOINT') + '?' + params2)
    data2_json = json.dumps(data2, indent=4)

    print(data2_json)  """
