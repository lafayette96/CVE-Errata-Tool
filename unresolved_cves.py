import requests
import json
import sys
import getopt
import pprint
import re

API_HOST = 'https://access.redhat.com/hydra/rest/securitydata'
endpoint = '/cve.json'
#params = 'after=2022-09-01' + '&' + 'before=2022-09-06' # + 'product=openstack' + 'sevrity=important' + 'ids=CVE-2022-2735' 


def get_data(query):
    full_query = API_HOST + query
    r = requests.get(full_query)

    if r.status_code != 200:
        print('ERROR: Invalid request; returned' + str(r.status_code) + 'for the following query: \n' + full_query)

    if not r.json():
        print('\nNo data returned with the following query: \n' + full_query)
        print('\n')
        sys.exit(0)

    return r.json()


def pretty_print_cve(data):

    cves_printed = []
    print('\n')

    for cve in data:

        # for each CVE, make another call to API
        cve_query = "/cve/" + cve['CVE']
        cve_data = get_data(cve_query)

        # TODO: figure the logic to decide whether the CVE is resolved or not
        # Show: 
        # - CVEs released within specified time period
        # - CVEs released earlier that had the errata released within that period
        # - CVEs released earlier, without errata released
   
        # variable to store affected packages
        affected_packages = {}
        details ='\n'

        # concatenate a list of descriptions into one block of text
        for description in cve_data['details']:
            details += description
            details += '\n'

        # check is there are mitigation steps provided
        if "mitigation" in cve_data:
            mitigation = cve_data["mitigation"]["value"]
        else:
            mitigation = "No mitigation strategy provided so far."

        # gather package details
        try:
            for package in cve_data["package_state"]:
                name = package["product_name"]
                fix_state = package["fix_state"]
                if re.search(arg_product, name, re.IGNORECASE):
                    affected_packages[name] = fix_state 
        except:
            print('\n**********************************\n\nAn exception occured for: ' + cve['CVE'] + '\nNo affected packages found.' + '\n\n**********************************\n\n')
        

        if cve['CVE'] not in cves_printed:
            print('CVE Number: \t| Severity: | Public date: | URL: ')
            cves_printed.append(cve['CVE'])
            print('{:<15} | {:<9} | {:<12} | {:<50}'.format(cve['CVE'], cve['severity'], cve['public_date'][0:10], cve['resource_url'])) # print details
            print('\nDescription: ' + details) # print description
            #print('')
            print('Mitigation: \n' + mitigation) # print mitigation
            
            '''pprint.pprint(affected_packages)
            print(json.dumps(affected_packages, indent=4, sort_keys=True))
            print(*[str(k) + ' : ' + str(v) + '\n' for k,v in affected_packages.items()])'''

            print('\nAffected product: \t\t\t\t\t\t| Fix state:  ')
            for k, v in affected_packages.items():
                if arg_remove_unaffected == 'yes': 
                    if v != "Not affected":
                        print('{:<63} | {:<20}'.format(k, v))
                else:
                    print('{:<63} | {:<20}'.format(k, v))
            print('\n\n----------------------------------------------------------------------------------------------------------------------------------------------\n\n')
    
    print(cves_printed)
    print('\n')
    #print(arg_product)


def parse_input(argv):
    arg_after = ''
    arg_before = ''
    global arg_product 
    ar_product = ''
    arg_severity = ''
    global arg_remove_unaffected 
    arg_remove_unaffected = ''
    arg_help = '{0} -a <after> -b <before> -p <product> -s <severity> -r <remove-unaffected> '.format(argv[0])

    try: 
        opts, args = getopt.getopt(argv[1:], "ha:b:p:s:r:", ["help", "after=", "before=", "product=", "severity=", "remove-unaffected="])
    except:
        print(arg_help)
        sys.exit(2)

    params = ""

    for opt, arg in opts:
        if opt in ("-h", "--help"):
            print(arg_help) #print the help message
            sys.exit(2)
        elif opt in ("-a", "--after"):
            arg_after = arg
            if not params:
                params += 'after=' + arg_after
            else: 
                params += '&after=' + arg_after
        elif opt in ("-b", "--before"):
            arg_before = arg
            if not params:
                params += 'before=' + arg_before
            else:
                params += '&before=' + arg_before
        elif opt in ("-p", "--product"):
            arg_product = arg
            if not params:
                params += 'product=' + arg_product
            else:
                params += '&product=' + arg_product
        elif opt in ("-s", "--severity"):
            arg_severity = arg
            if not params:
                params += 'severity=' + arg_severity
            else:
                params += '&severity=' + arg_severity
        elif opt in ("-r", "--remove-unaffected"):
            arg_remove_unaffected = arg

    return params


if __name__ == "__main__":
    
    params = parse_input(sys.argv)
    data = get_data(endpoint + '?' + params)
    pretty_print_cve(data)